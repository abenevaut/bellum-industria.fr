sudo: required
dist: trusty
language: php

git:
  submodules: true

addons:
  chrome: stable
  #firefox: latest
  hosts:
    - www.bellum-industria.fr.local

cache:
  apt: true
  directories:
    - $HOME/.composer/cache
    - vendor
    - node_modules
    - resources/assets/bower

matrix:
  fast_finish: true
  include:
    - php: 7.2
      env:
        - BLACKFIRE=on
        - CODECLIMATE=off # service not allowed for organisation without plan
    - php: nightly
  allow_failures:
    - php: nightly

before_install:
  - printf "\n" | pecl install imagick
#  - |
#    if [[ "$BLACKFIRE" = "on" ]]; then
#        openssl aes-256-cbc -K $encrypted_4c534e220dbe_key -iv $encrypted_4c534e220dbe_iv -in .blackfire.travis.ini.enc -out .blackfire.ini -d
#        curl -L https://blackfire.io/api/v1/releases/agent/linux/amd64 | tar zxpf -
#        chmod 755 agent && ./agent --config=~/.blackfire.ini --socket=unix:///tmp/blackfire.sock &
#    fi
#  - |
#    if [[ "$CODECLIMATE" = "on" ]]; then
#        curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
#        chmod +x ./cc-test-reporter
#    fi
#  - cp .env.dusk.testing .env
  - nvm install
  - nvm use

install:
  - travis_retry composer install -o --no-interaction --prefer-dist --no-suggest
  - travis_retry npm install
  - travis_retry npm run bower

before_script:
#  - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
#  - php artisan serve &
#  - |
#    if [[ "$BLACKFIRE" = "on" ]]; then
#        curl -L https://blackfire.io/api/v1/releases/probe/php/linux/amd64/$(php -r "echo PHP_MAJOR_VERSION . PHP_MINOR_VERSION;")-zts | tar zxpf -
#        echo "extension=$(pwd)/$(ls blackfire-*.so | tr -d '[[:space:]]')" > ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/blackfire.ini
#        echo "blackfire.agent_socket=unix:///tmp/blackfire.sock" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/blackfire.ini
#    fi
#  - |
#    if [[ "$CODECLIMATE" = "on" ]]; then
#        ./cc-test-reporter before-build
#    fi

script:
#  - php artisan dusk
  - vendor/bin/phpunit

after_script:
#  - |
#    if [[ "$CODECLIMATE" = "on" ]]; then
#        ./cc-test-reporter after-build -t clover --exit-code $TRAVIS_TEST_RESULT
#    fi
