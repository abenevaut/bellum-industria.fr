image: tmaier/docker-compose:latest

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay
  GIT_SSL_NO_VERIFY: "1"
  GIT_SUBMODULE_STRATEGY: recursive

docker-unit:
  stage: build
  tags:
    - docker
  script:
    - docker-compose --project-name cibellumindustria build workspace blackfire

style:
  stage: build
  tags:
    - docker
  before_script:
    - docker-compose --project-name cibellumindustria up -d workspace
    - docker-compose --project-name cibellumindustria exec -T workspace npm install
    - docker-compose --project-name cibellumindustria exec -T workspace npm run bower:install
  script:
    - docker-compose --project-name cibellumindustria exec -T workspace npm run production
  after_script:
    - docker-compose --project-name cibellumindustria stop
    - docker-compose --project-name cibellumindustria rm -f
    - rm -rf vendor storage/docker

unit:
  stage: test
  tags:
    - docker
  before_script:
    - cp .env.example .env
    - docker-compose --project-name cibellumindustria build workspace blackfire
    - docker-compose --project-name cibellumindustria up -d workspace blackfire
    - docker-compose --project-name cibellumindustria exec -T workspace php /usr/local/bin/composer install
    - docker-compose --project-name cibellumindustria exec -T workspace php /var/www/artisan key:generate
  script:
    - docker-compose --project-name cibellumindustria exec -T workspace php /var/www/vendor/bin/phpunit
  after_script:
    - docker-compose --project-name cibellumindustria stop
    - docker-compose --project-name cibellumindustria rm -f
    - rm -rf vendor storage/docker
